# Updated System Design Document: "Power in Numbers" (Phase 2: Collaboration)

## 1. Architecture Change
Moving from a client-side state model to a cloud-based relational model using **Firebase**.

* **Auth:** Firebase Authentication (Email/Password).
* **Database:** Cloud Firestore.
* **Frontend:** Vue 3 + Pinia (Stores will now act as data caches).

## 2. Updated Data Model (Firestore Schema)

### Collection: `users`
*Represents the "Micro" view. Private to the user.*
```typescript
interface UserProfile {
  uid: string; // Document ID
  email: string;
  displayName: string;

  // The Financial Profile
  financialData: {
    annualExpenses: number;
    desiredWorkWeeks: number;
    desiredDailyHours: number;
    nonBillablePercent: number;
    // ... all other fields from original CSV
  };

  // Computed (Cached for easy reading by projects)
  cachedGoalRate: number;
  cachedNowRate: number;
}
```

### Collection: `projects`

*Represents the "Macro" view. Shared by collaborators.*

```typescript
interface Project {
  id: string; // Document ID
  ownerId: string; // The user who created it
  name: string;

  // Global Project Levers
  scenarios: {
    [scenarioId: string]: {
      name: string;
      wageFloor: number;
      payPercentage: number;
    }
  };

  incomeSources: IncomeSource[]; // Confirmed/Unconfirmed grants
}
```

### Sub-Collection: `projects/{projectId}/members`

*The logic that links a User to a Project Phase.*

```typescript
interface ProjectMember {
  userId: string; // Link to the `users` collection
  projectId: string;

  // Project specific overrides
  assignedPhaseId: string;
  assignedHours: number;

  // Snapshot Data (Optional)
  // We might store a snapshot of their rate at the time of contract,
  // or pull it live. For now, let's pull LIVE data.
}
```

## 3\. Revised Component/View Flow

### A. Authentication View (New)

  * **Login/Signup:** Simple form.
  * **Onboarding:** If a new user signs up, redirect to `CollaboratorWizard` to establish their baseline "Goal Rate."

### B. The User Dashboard (Home)

  * **Section 1: My Financial Health.** (ReadOnly view of their calculated rates). Button to "Edit My Finances" (routes to `CollaboratorWizard`).
  * **Section 2: My Projects.** List of projects they own or are invited to.

### C. The Project Builder (Updated Logic)

  * **Adding a Collaborator:**
      * *Old Way:* User manually typed a name and a rate.
      * *New Way:* User clicks "Add Collaborator" -\> Enters **Email**.
      * *System Action:* Looks up User by Email.
          * *Found:* Adds them to the project. The table immediately populates their `Goal Rate` column from their private `users` document.
          * *Not Found:* (MVP) Create a "Ghost User" where the Project Lead manually types in an estimated rate.

## 4\. Pinia Store Refactoring

We need to split the monolithic `budget.js` store.

**1. `useUserStore`**

  * Actions: `fetchMyProfile()`, `updateFinancials()`, `calculateRates()`.
  * State: `currentUser`, `financialProfile`.

**2. `useProjectStore`**

  * Actions:
      * `createProject()`
      * `fetchProject(id)`
      * `addCollaborator(email)` -\> Queries Firestore for user, adds to `members`.
      * `updateScenario(wageFloor, percentage)`
  * State: `activeProject`, `collaborators` (Array of objects containing both project-specific hours AND the user's fetched financial rates).

## 5\. Security Rules (Brief)

  * `users/{uid}`: Read/Write only by `request.auth.uid == uid`.
  * `projects/{projectId}`: Read/Write if `request.auth.uid` is in the members list or is the owner.
